@inject IToastService toastService
@inject XpoService<PlantillaPregunta> PreguntaService
@inject XpoService<PlantillaRespuesta> RespuestaService

<DxPopup @bind-Visible="PopUpVisible" CssClass="modal-lg" CloseButtonClick="() => PopUpVisible = false" Scrollable="true">
    <Content>
        @if (DataGridVisible)
        {
            <DxDataGrid Data="data">
                <Columns>
                    <DxDataGridColumn Field="Enunciado" />
                </Columns>
                <RowPreviewTemplate>
                    <ul>
                        <li>@context.DataItem.RespuestaA</li>
                        <li>@context.DataItem.RespuestaB</li>
                        <li>@context.DataItem.RespuestaC</li>
                        <li>@context.DataItem.RespuestaD</li>
                    </ul>
                </RowPreviewTemplate>
            </DxDataGrid>
        }
        else
        {
            <div style="height:600px">
                <BlazoredTextEditor @ref="TextEditor" Theme="bubble" />
            </div>
        }
    </Content>
    <FooterTemplate>
        <DxButton Text="Procesar" Click="x => InvokeAsync(Procesar)" Visible="!DataGridVisible" />
        <DxButton Text="Guardar" Click="x => InvokeAsync(Guardar)" Visible="DataGridVisible" />
    </FooterTemplate>
</DxPopup>

@code {
    BlazoredTextEditor TextEditor;
    List<EditContext> data = new List<EditContext>();

    bool popUpVisible;
    bool PopUpVisible
    {
        get => popUpVisible;
        set
        {
            if (popUpVisible == value) return;
            popUpVisible = value;
            InvokeAsync(StateHasChanged);
        }
    }

    bool dataGridVisible;
    bool DataGridVisible
    {
        get => dataGridVisible;
        set
        {
            if (dataGridVisible == value) return;
            dataGridVisible = value;
            InvokeAsync(StateHasChanged);
        }
    }


    [Parameter]
    public Tema Tema { get; set; }

    public void IniciarImportacion()
    {
        data.Clear();
        DataGridVisible = false;
        PopUpVisible = true;
    }

    async Task Procesar()
    {
        try
        {
            data.Clear();
            string texto = await TextEditor.GetText();
            var array = texto.Split('\n', StringSplitOptions.RemoveEmptyEntries);
            for (int i = 0; i < array.Length; i += 5)
            {
                data.Add(new EditContext
                {
                    Enunciado = array[i],
                    RespuestaA = array[i + 1].Substring(3),
                    RespuestaB = array[i + 2].Substring(3),
                    RespuestaC = array[i + 3].Substring(3),
                    RespuestaD = array[i + 4].Substring(3),
                });
            }
            DataGridVisible = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            toastService.ShowError(ex.ToString(), "Error");
        }
    }

    async Task Guardar()
    {
        try
        {
            foreach (EditContext datos in data)
            {
                var pregunta = await PreguntaService.Add(new Dictionary<string, object> { { "Tema", Tema?.Oid }, { "Enunciado", datos.Enunciado } });
                await RespuestaService.Add(new Dictionary<string, object> { { "Pregunta", pregunta.Oid }, { "Texto", datos.RespuestaA } });
                await RespuestaService.Add(new Dictionary<string, object> { { "Pregunta", pregunta.Oid }, { "Texto", datos.RespuestaB } });
                await RespuestaService.Add(new Dictionary<string, object> { { "Pregunta", pregunta.Oid }, { "Texto", datos.RespuestaC } });
                await RespuestaService.Add(new Dictionary<string, object> { { "Pregunta", pregunta.Oid }, { "Texto", datos.RespuestaD } });
            }
            toastService.ShowSuccess("Preguntas generadas", "OK");
        }
        catch (Exception ex)
        {
            toastService.ShowError(ex.ToString(), "Error");
        }

        finally
        {
            DataGridVisible = false;
            PopUpVisible = false;
            StateHasChanged();
        }

    }

    public class EditContext
    {
        public string Enunciado { get; set; }
        public string RespuestaA { get; set; }
        public string RespuestaB { get; set; }
        public string RespuestaC { get; set; }
        public string RespuestaD { get; set; }
    }
}